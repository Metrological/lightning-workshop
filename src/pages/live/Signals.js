import Page from "../../Page.js";
import BulletPoint from "../BulletPoint.js";
import Table from "../../Table.js";

export default class Signals extends Page {

    static _template() {
        return {
            Bullets: {
                y: 100,
                x: 40,
                flex: {direction: 'column'},
                Wrap: {
                    flex: {direction: 'column'},
                    children: [
                        {type: BulletPoint, content: Signals.text("Child-Parent communication")},
                        {type: BulletPoint, content: Signals.text("Parent defines which signals are handled")},
                        {type: BulletPoint, content: Signals.text("Arguments, return value")},
                        {type: BulletPoint, content: Signals.text("passSignals:{selected:\"select\"}", 0xFFFFFFFF, 'normal',{fontFace: "helvetica"})},
                    ]
                }
            }
        };
    }

    get title() {
        return "Signals";
    }

    _active() {
        this.tag("Wrap").children.forEach((child, index) => child.show(index * 0.2));
    }

    _inactive() {
        this.tag("Wrap").children.forEach(child => child.hide());
    }

    get liveEditOptions() {
        const actions = [[{"start":{"row":56,"column":44},"end":{"row":57,"column":0},"action":"insert","lines":["",""],"id":10,"reload":true},{"start":{"row":57,"column":0},"end":{"row":57,"column":32},"action":"insert","lines":["                                "]},{"start":{"row":57,"column":32},"end":{"row":57,"column":33},"action":"insert","lines":["d"]},{"start":{"row":57,"column":33},"end":{"row":57,"column":34},"action":"insert","lines":["e"]},{"start":{"row":57,"column":34},"end":{"row":57,"column":35},"action":"insert","lines":["b"]},{"start":{"row":57,"column":35},"end":{"row":57,"column":36},"action":"insert","lines":["u"]},{"start":{"row":57,"column":36},"end":{"row":57,"column":37},"action":"insert","lines":["g"]},{"start":{"row":57,"column":37},"end":{"row":57,"column":38},"action":"insert","lines":["g"]},{"start":{"row":57,"column":38},"end":{"row":57,"column":39},"action":"insert","lines":["e"]},{"start":{"row":57,"column":39},"end":{"row":57,"column":40},"action":"insert","lines":["r"]},{"start":{"row":57,"column":40},"end":{"row":57,"column":41},"action":"insert","lines":[";"]}],[{"start":{"row":57,"column":72},"end":{"row":57,"column":73},"action":"insert","lines":["."],"id":9,"reload":true},{"start":{"row":57,"column":73},"end":{"row":57,"column":74},"action":"insert","lines":["d"]}],[{"start":{"row":57,"column":72},"end":{"row":57,"column":73},"action":"remove","lines":["D"],"id":8}],[{"start":{"row":56,"column":44},"end":{"row":56,"column":45},"action":"remove","lines":["a"],"id":7},{"start":{"row":56,"column":43},"end":{"row":56,"column":44},"action":"remove","lines":["t"]},{"start":{"row":56,"column":42},"end":{"row":56,"column":43},"action":"remove","lines":["a"]},{"start":{"row":56,"column":41},"end":{"row":56,"column":42},"action":"remove","lines":["D"]}],[{"start":{"row":119,"column":0},"end":{"row":123,"column":0},"action":"remove","lines":["    _selected(movie) {","        this.signal('select', movie.data);","    }","    ",""],"id":6}],[{"start":{"row":115,"column":88},"end":{"row":115,"column":89},"action":"insert","lines":["s"],"id":5},{"start":{"row":115,"column":89},"end":{"row":115,"column":90},"action":"insert","lines":["e"]},{"start":{"row":115,"column":90},"end":{"row":115,"column":91},"action":"insert","lines":["l"]},{"start":{"row":115,"column":91},"end":{"row":115,"column":92},"action":"insert","lines":["e"]},{"start":{"row":115,"column":92},"end":{"row":115,"column":93},"action":"insert","lines":["c"]},{"start":{"row":115,"column":93},"end":{"row":115,"column":94},"action":"insert","lines":["t"]}],[{"start":{"row":115,"column":96},"end":{"row":115,"column":97},"action":"remove","lines":["d"],"id":4},{"start":{"row":115,"column":95},"end":{"row":115,"column":96},"action":"remove","lines":["e"]},{"start":{"row":115,"column":94},"end":{"row":115,"column":95},"action":"remove","lines":["t"]},{"start":{"row":115,"column":93},"end":{"row":115,"column":94},"action":"remove","lines":["c"]},{"start":{"row":115,"column":92},"end":{"row":115,"column":93},"action":"remove","lines":["e"]},{"start":{"row":115,"column":91},"end":{"row":115,"column":92},"action":"remove","lines":["l"]},{"start":{"row":115,"column":90},"end":{"row":115,"column":91},"action":"remove","lines":["e"]},{"start":{"row":115,"column":89},"end":{"row":115,"column":90},"action":"remove","lines":["s"]},{"start":{"row":115,"column":88},"end":{"row":115,"column":89},"action":"remove","lines":["_"]}],[{"start":{"row":115,"column":67},"end":{"row":115,"column":68},"action":"remove","lines":["s"],"id":3},{"start":{"row":115,"column":67},"end":{"row":115,"column":68},"action":"insert","lines":["S"]}],[{"start":{"row":115,"column":63},"end":{"row":115,"column":64},"action":"insert","lines":["p"],"id":2},{"start":{"row":115,"column":64},"end":{"row":115,"column":65},"action":"insert","lines":["a"]},{"start":{"row":115,"column":65},"end":{"row":115,"column":66},"action":"insert","lines":["s"]},{"start":{"row":115,"column":66},"end":{"row":115,"column":67},"action":"insert","lines":["s"]}],[{"start":{"row":0,"column":0},"end":{"row":279,"column":1},"action":"insert","lines":["class MyApp extends lng.Application {","","    static _template() {","        return {","            Content: {","                alpha: 0,","                List: {alpha: 0, type: MovieList, signals: {select: \"_select\"}},","                Details: {alpha: 0, type: MovieDetails}","            },","            Loader: {rect: true, color: 0xFF000000, w: 1920, h: 1080,","                Label: {text: {text: \"Loading..\", fontSize: 60}, mount: 0.5, x: 1920/2, y: 1080/2}","            }","        }","    }","    ","    _init() {","        this._setState(\"Loading\");","    }","    ","    static _states() {","        return [","            class Loading extends this {","                $enter() {","                    this.tag(\"Loader\").visible = true;","                    ","                    Api.getTopMovies().then((movies) => {","                        this._loaded(movies);","                    });","                }","                $exit() {","                    this.tag(\"Loader\").visible = false;","                }","                _loaded(movies) {","                    this.tag(\"List\").movies = movies;","                    this._setState(\"Content.List\");","                }","            },","            class Content extends this {","                $enter() {","                    this.tag(\"Content\").setSmooth('alpha', 1);","                }","                $exit() {","                    this.tag(\"Content\").setSmooth('alpha', 0);","                }","                static _states() {","                    return [","                        class List extends this {","                            $enter() {","                                this.tag(\"List\").setSmooth('alpha', 1);","                            }","                            $exit() {","                                this.tag(\"List\").setSmooth('alpha', 0);","                            }","                            _getFocused() {","                                return this.tag(\"List\");","                            }","                            _select(movieData) {","                                this._setState(\"Content.Details\", [movieData]);","                            }","                        },","                        class Details extends this {","                            $enter(context, movieData) {","                                this.tag(\"Details\").movie = movieData;","                                this.tag(\"Details\").setSmooth('alpha', 1);","                            }","                            $exit() {","                                this.tag(\"Details\").setSmooth('alpha', 0);","                            }","                            _getFocused() {","                                return this.tag(\"Details\");","                            }","                            _handleBack() {","                                this._setState(\"Content.List\");","                            }","                        }                        ","                    ]","                }","","            }","        ]","    }","    ","}","","class MovieDetails extends lng.Component {","    static _template() {","        return {","            rect: true, w: 1920, h: 1080, color: 0xFF005500,","            Title: {mountY: 1, y: 800,","            text: {fontSize: 90, fontStyle: 'bold'}}","        }","    }","    ","    set movie(data) {","        this.tag(\"Title\").text.text = data.title;","    }","}","","","class MovieList extends lng.Component {","    static _template() {","        return {","            Title: {x: 50, text: {text: \"Top movies\", fontSize: 60, fontStyle: 'bold'}},","            Scroller: {y: 100, w: 1920, h: 400,","                Items: {}","            }","        }","    }","    ","    _construct() {","        this._index = 0;","    }","    ","    set movies(movies) {","        this.tag(\"Items\").children = movies.map((movie, index) => ({","            type: MovieItem, data: movie, x: index * 640 + 50, signals: {selected: \"_selected\"}","        }));","    }","    ","    _selected(movie) {","        this.signal('select', movie.data);","    }","    ","    get _movies() {","        return this.tag(\"Items\").childList;","    }","","    _handleRight() {","        if (this._index < this._movies.length - 1) {","            this._setIndex(this._index + 1);","        }","    }","    ","    _handleLeft() {","        if (this._index > 0) {","            this._setIndex(this._index - 1);","        }","    }","    ","    ","    _setIndex(index) {","        this._index = index;","        let x = Math.max(0, Math.min(index - 2, this._movies.length - 3)) * 640;","        this.tag(\"Items\").setSmooth('x', -x);","    }","    ","    _getFocused() {","        return this._movies.getAt(this._index);","    }","    ","}","","class MovieItem extends lng.Component {","    static _template() {","        return {","            w: 600,","            h: 400,","            clipping: true,","            Background: {","            },","            Info: {","                mountY: 1,","                y: 444,","                w: 600,","                rect: true, color: 0x99000000,","                flex: {direction: 'column'},","                Title: {","                    flexItem: {marginLeft: 10, marginRight: 10},","                    text: {wordWrapWidth: 580, fontSize: 60, fontStyle: 'bold'}","                },","                Metadata: {","                    flexItem: {alignSelf: 'stretch'},","                    flex: {padding: 14, paddingTop: 0, justifyContent: 'space-between'},","                    Left: {","                        flex: {},","                        Year: {","                            flexItem: {marginRight: 10},","                            text: {fontSize: 20, fontStyle: 'bold'}","                        },","                        Genre: {","                            text: {fontSize: 20, fontStyle: 'bold'}","                        }","                        ","                    },","                    Rating: {","                        y: 4,","                        w: 107,","                        h: 17,","                        flexItem: {marginRight: 10},","                        Back: {","                            texture: {","                                type: lng.textures.ImageTexture,","                                src: \"./live/img/star-back.png\"","                            }","                        },","                        Front: {","                            texture: {","                                type: lng.textures.ImageTexture,","                                src: \"./live/img/star-front.png\"","                            }","                        }","                        ","                    }","                }","                ","            }","        }","    }","","    get data() {","        return this._data;","    }    ","    ","    set data(data) {","        this._data = data;","        this.patch({","            Background: {src: data.image},","            Info: {","                Title: {","                    text: {text: data.title}","                },","                Metadata: {","                    Left: {","                        Year: {text: {text: data.year}},","                        Genre: {text: {text: data.genre}},","                    },","                    Rating: {","                        Front: {","                            texture: {w: (data.rating * (107 / 10))},","                        }","                    }","                }","            }","        });","    }","    ","    _focus() {","        this.tag(\"Info\").setSmooth('y', 400);","    }","    ","    _unfocus() {","        this.tag(\"Info\").setSmooth('y', 444);","    }    ","    ","    _handleEnter() {","        this._setState(\"Selecting\");","    }","    ","    _build() {","        this._selectAnimation = this.animation({duration: 0.1, autostop: true, stopDuration: 0.2, ","            actions: [","                {p:'scale',v:{0:1,1:1.05}}","            ]","        });","        ","        this._selectAnimation.on('finish', () => {","            this._selectAnimationFinished();","        });","        ","    }","    ","    static _states() {","        return [","            class Selecting extends this {","                $enter() {","                    this._selectAnimation.start();","                }","                ","                _unfocus() {","                    this._setState(\"\");","                    super._unfocus();","                }","                ","                _selectAnimationFinished() {","                    this.signal('selected', this);","                }","            }    ","        ]","    }","}"],"id":1}]];
        return {isApp: true, data: {actions: actions}};
    }

    static text(text, color = 0xFFFFFFFF, fontStyle = '', extra) {
        return {flexItem: {}, color: color, text: Object.assign({text: text, fontSize: 48, fontStyle}, extra)};
    }

}